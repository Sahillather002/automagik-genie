# Genie CLI Bug Report
**Date**: 2025-09-29 19:48 UTC
**Version**: codex@0.43.0-alpha.5
**Tester**: Manual QA Session
**Context**: Comprehensive CLI testing after identity bug hotfix

---

## Bugs Discovered

### Bug #1: Background Run Session ID Not Displayed
**Severity**: HIGH
**Command**: `./genie run <agent> "<prompt>"`
**Expected**: Display session ID and management commands after session starts
**Actual**: Shows "Waiting for the executor to publish the session id" indefinitely and returns without showing:
- Final session ID
- Management commands (view, resume, stop)

**Evidence**:
```bash
./genie run plan "Quick test message to create a session"
# Output shows:
# ⠙ Linking session id
# ⏳ Hold tight
# Waiting for the executor to publish the session id.
# [Never completes or shows session ID]
```

**Impact**: Users cannot get the session ID to manage their background runs without running `./genie list sessions` separately.

**Root Cause** (suspected): `resolveSessionIdForBanner` in genie.ts:1323-1397 may be timing out or not properly polling for session ID extraction.

---

### Bug #2: View Command Shows "No Transcript" Without --full Flag
**Severity**: HIGH
**Command**: `./genie view <sessionId>`
**Expected**: Show recent messages from the session (last 20 or last 2 assistant messages)
**Actual**: Shows "No transcript yet" even when session completed successfully with messages

**Evidence**:
```bash
# Without --full
./genie view 019996ef-b376-7da1-ae7f-dae1ba4452dd
# Shows: "ℹ️ No transcript yet - Agent has not produced chat output for this session."

# With --full
./genie view 019996ef-b376-7da1-ae7f-dae1ba4452dd --full
# Shows: Full transcript with all messages correctly
```

**Impact**: Users cannot see session messages without using `--full` flag, making quick checks impossible.

**Root Cause** (suspected):
- `sliceTranscriptForRecent` in genie.ts:1724-1743 may have logic error
- OR `buildTranscriptFromEvents` in genie.ts:1615-1705 may not be parsing events correctly
- Likely the transcript filtering is too aggressive or the event parsing is incomplete

**Session Details**:
- Session: 019996ef-b376-7da1-ae7f-dae1ba4452dd
- Agent: utilities/thinkdeep
- Status: completed
- Executor: codex
- Background: true

---

### Bug #3: No --preset CLI Flag Despite Documentation
**Severity**: MEDIUM (Documentation Issue)
**Issue**: Documentation suggests `--preset <name>` flag exists, but CLI doesn't parse it
**Expected**: `./genie run <agent> "<prompt>" --preset careful` should work
**Actual**: Flag is ignored; execution mode must be set in agent YAML or config file

**Evidence**:
- Parser in genie.ts:256-292 only recognizes: `--help`, `--full`, `--live`
- No `--preset` or `--mode` flag handling

**Impact**: Users cannot override execution mode via CLI; must edit agent files or config.

**Solution**: Either:
1. Add `--mode <name>` CLI flag support
2. Update documentation to clarify modes are agent/config-level only

---

### Bug #4: Session ID Truncated in List Display
**Severity**: LOW
**Command**: `./genie list sessions`
**Issue**: Session IDs are truncated with "…" making them hard to copy
**Example**: `019996fc-939c-7350-9737-018f89 1…` (should show full UUID)

**Evidence**:
```
│ plan   ❌ failed   019996fc-939c-7350-9737-018f89  5m ago │
│                    1…                                     │
```

**Impact**: Users must read `.genie/state/agents/sessions.json` to get full session IDs.

---

## Test Environment
- Working Directory: `/home/namastex/workspace/automagik-genie`
- State: Fresh `.genie/state/` (deleted before testing)
- Sessions Tested:
  - plan: 019996fc-939c-7350-9737-018f891dc4dc (failed)
  - utilities/thinkdeep: 019996ef-b376-7da1-ae7f-dae1ba4452dd (completed)
  - utilities/identity-check: 019996e7-8b8c-72d3-a33b-8dce00de822e (completed)

---

### Bug #5: Incorrect Error Message for Invalid Agent
**Severity**: LOW
**Issue**: Error message suggests wrong command syntax
**Error Message**: `❌ Agent 'nonexistent-agent' not found. Try 'genie agent list' to see available ids.`
**Correct Command**: Should be `'genie list agents'` (not `'genie agent list'`)

**Evidence**:
```bash
./genie run nonexistent-agent "test"
# Shows: Try 'genie agent list' to see available ids.
# Should say: Try 'genie list agents' to see available ids.
```

**Location**: genie.ts:1598 in `resolveAgentIdentifier` function

**Impact**: Confuses users by suggesting incorrect command syntax.

---

## Functions Tested ✅
- [x] `./genie run <agent> "<prompt>"` - Bug #1 found
- [x] `./genie resume <sessionId> "<prompt>"` - Works correctly, shows session ID immediately
- [x] `./genie stop <sessionId>` - Works correctly
- [x] `./genie list agents` - Works correctly
- [x] `./genie list sessions` - Works correctly (Bug #4: ID truncation)
- [x] `./genie view <sessionId>` - Bug #2 found
- [x] `./genie view <sessionId> --full` - Works correctly
- [x] Error handling (invalid session ID) - Works correctly
- [x] Error handling (invalid agent name) - Works but shows wrong command (Bug #5)

## Functions Not Yet Tested
- [ ] Foreground mode (agent with `background: false` in frontmatter)
- [ ] Concurrent runs (multiple agents simultaneously)
- [ ] `./genie view` with `--live` flag
- [ ] Agent execution with execution mode set in frontmatter

---

## Recommended Fixes

### Priority 1 (Critical)
1. Fix Bug #1: Session ID display timeout/polling issue
2. Fix Bug #2: View command transcript parsing/slicing

### Priority 2 (High)
3. Add `--mode` CLI flag OR update docs to remove preset references
4. Fix session ID truncation in list view

### Priority 3 (Enhancement)
5. Add integration tests for CLI commands
6. Add timeout handling for background session ID extraction
7. Improve error messages for common failures